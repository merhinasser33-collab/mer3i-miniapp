<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>ØªØ³Ø¬ÙŠÙ„ Ø¯Ø®ÙˆÙ„ - Mer3i Market</title>

  <!-- Telegram WebApp -->
  <script src="https://telegram.org/js/telegram-web-app.js"></script>

  <style>
    body{margin:0;font-family:Arial,sans-serif;background:#f6f7fb;color:#111}
    .wrap{max-width:720px;margin:24px auto;padding:0 14px}
    .card{background:#fff;border-radius:18px;padding:18px;box-shadow:0 6px 18px rgba(0,0,0,.08);border:1px solid rgba(0,0,0,.06)}
    h1{margin:0 0 12px;font-size:26px}
    .muted{color:#666;line-height:1.7;margin:6px 0}
    .tabs{display:flex;gap:10px;margin:14px 0 10px}
    .tab{flex:1;border:1px solid rgba(0,0,0,.1);background:#f2f4f8;padding:12px;border-radius:14px;cursor:pointer;font-weight:700}
    .tab.active{background:#2b7cff;color:#fff;border-color:#2b7cff}
    label{display:block;margin:10px 0 6px;font-weight:700}
    input{width:100%;padding:12px 12px;border-radius:12px;border:1px solid rgba(0,0,0,.15);font-size:16px;outline:none}
    .row{display:flex;gap:10px;flex-wrap:wrap;margin-top:14px}
    button,a.btn{border:0;border-radius:12px;padding:12px 14px;font-size:16px;cursor:pointer;background:#2b7cff;color:#fff;text-decoration:none;display:inline-flex;align-items:center;gap:8px}
    button.gray{background:#e9edf5;color:#111}
    button.dark{background:#111}
    button.danger{background:#ff3b30}
    .hide{display:none!important}
    .msg{margin-top:12px;padding:12px;border-radius:12px;background:#f2f4f8;border:1px solid rgba(0,0,0,.08)}
    .ok{color:#0a8f3e;font-weight:800}
    .bad{color:#c62828;font-weight:800}
    .tiny{font-size:13px;color:#777;margin-top:10px}
    /* Ù†Ø®Ù„ÙŠ reCAPTCHA ØµØºÙŠØ±/Ù…Ø®ÙÙŠ Ù‚Ø¯Ø± Ø§Ù„Ø¥Ù…ÙƒØ§Ù† */
    #recaptcha-container{transform:scale(.92);transform-origin:right top}
  </style>
</head>

<body>
  <div class="wrap">
    <div class="card">
      <h1>ğŸ” ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</h1>
      <p class="muted">
        Ø§Ø®ØªØ± Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø¯Ø®ÙˆÙ„: <b>Ø¨Ø±ÙŠØ¯</b> Ø£Ùˆ <b>Ù‡Ø§ØªÙ</b>.  
        (ÙƒÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ØªØ¨Ù‚Ù‰ Ø¯Ø§Ø®Ù„ Firebase ÙˆÙ„Ø§ ØªØ¸Ù‡Ø± Ù„Ù„Ù†Ø§Ø³).
      </p>

      <div class="tabs">
        <div class="tab active" id="tabEmail" onclick="switchTab('email')">ğŸ“§ Ø¨Ø±ÙŠØ¯</div>
        <div class="tab" id="tabPhone" onclick="switchTab('phone')">ğŸ“± Ù‡Ø§ØªÙ</div>
      </div>

      <!-- EMAIL -->
      <div id="panelEmail">
        <label>Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ</label>
        <input id="email" type="email" placeholder="example@gmail.com" autocomplete="email"/>

        <label>ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±</label>
        <input id="password" type="password" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢" autocomplete="current-password"/>

        <div class="row">
          <button onclick="emailLogin()">ØªØ³Ø¬ÙŠÙ„ Ø¯Ø®ÙˆÙ„</button>
          <button class="dark" onclick="emailSignup()">Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨</button>
          <button class="gray" onclick="emailReset()">Ù†Ø³ÙŠØª ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±</button>
        </div>
      </div>

      <!-- PHONE -->
      <div id="panelPhone" class="hide">
        <label>Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ (Ù…Ø¹ ÙƒÙˆØ¯ Ø§Ù„Ø¯ÙˆÙ„Ø©)</label>
        <input id="phone" type="tel" placeholder="+96170123456" autocomplete="tel"/>

        <div class="tiny">
          âš ï¸ Ù„Ø§Ø²Ù… ØªÙƒØªØ¨ Ø§Ù„Ø±Ù‚Ù… Ù‡ÙƒØ°Ø§: <b>+961</b> Ø«Ù… Ø§Ù„Ø±Ù‚Ù….
        </div>

        <!-- reCAPTCHA (Firebase ÙŠÙØ±Ø¶Ù‡ Ù„Ù„Ù‡Ø§ØªÙ) -->
        <div style="margin-top:12px">
          <div id="recaptcha-container"></div>
        </div>

        <div class="row">
          <button onclick="sendCode()">Ø¥Ø±Ø³Ø§Ù„ ÙƒÙˆØ¯</button>
          <button class="gray" onclick="clearPhoneFlow()">Ù…Ø³Ø­</button>
        </div>

        <div id="otpBox" class="hide">
          <label>Ø£Ø¯Ø®Ù„ Ø§Ù„ÙƒÙˆØ¯</label>
          <input id="otp" type="number" inputmode="numeric" placeholder="123456"/>

          <div class="row">
            <button class="dark" onclick="confirmCode()">ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø¯Ø®ÙˆÙ„</button>
          </div>
        </div>
      </div>

      <div id="message" class="msg hide"></div>

      <div class="row" style="margin-top:16px">
        <button class="gray" onclick="goHome()">â¬…ï¸ Ø±Ø¬ÙˆØ¹</button>
        <a class="btn dark" href="https://t.me/Mer3iMarket_bot">ğŸ¤– ÙØªØ­ Ø§Ù„Ø¨ÙˆØª</a>
      </div>

      <div class="tiny" id="dbg"></div>
    </div>
  </div>

  <!-- Firebase (Web SDK v10) -->
  <script type="module">
    /************ 1) Ø¶Ø¹ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Firebase Ù‡Ù†Ø§ ************/
    // Firebase Console -> Project settings -> Your apps -> Web app -> config
    const firebaseConfig = {
      apiKey: "PUT_API_KEY_HERE",
      authDomain: "PUT_AUTH_DOMAIN_HERE",
      projectId: "PUT_PROJECT_ID_HERE",
      storageBucket: "PUT_STORAGE_BUCKET_HERE",
      messagingSenderId: "PUT_SENDER_ID_HERE",
      appId: "PUT_APP_ID_HERE"
    };

    /************ 2) Imports ************/
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
    import {
      getAuth,
      setPersistence,
      browserLocalPersistence,
      onAuthStateChanged,
      signInWithEmailAndPassword,
      createUserWithEmailAndPassword,
      sendPasswordResetEmail,
      signOut,
      RecaptchaVerifier,
      signInWithPhoneNumber
    } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-auth.js";

    /************ 3) Init ************/
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);

    // Ø®Ù„ÙŠ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ù…Ø­ÙÙˆØ¸ Ø¹Ù„Ù‰ Ø§Ù„Ø¬Ù‡Ø§Ø²
    await setPersistence(auth, browserLocalPersistence);

    // Telegram WebApp (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)
    const tg = window.Telegram?.WebApp;
    if (tg) { tg.ready(); tg.expand(); }

    // UI helpers
    const $ = (id) => document.getElementById(id);
    function showMsg(text, ok=true){
      const el = $("message");
      el.classList.remove("hide");
      el.innerHTML = (ok ? `<span class="ok">âœ…</span> ` : `<span class="bad">âŒ</span> `) + text;
    }
    function hideMsg(){ $("message").classList.add("hide"); }

    // ØªØ¨ÙˆÙŠØ¨
    window.switchTab = (mode) => {
      hideMsg();
      if(mode === "email"){
        $("tabEmail").classList.add("active");
        $("tabPhone").classList.remove("active");
        $("panelEmail").classList.remove("hide");
        $("panelPhone").classList.add("hide");
      }else{
        $("tabPhone").classList.add("active");
        $("tabEmail").classList.remove("active");
        $("panelPhone").classList.remove("hide");
        $("panelEmail").classList.add("hide");
        ensureRecaptcha();
      }
    };

    // Ø±Ø¬ÙˆØ¹
    window.goHome = () => {
      // Ø¹Ø¯Ù„ Ø§Ù„Ø±Ø§Ø¨Ø· Ø­Ø³Ø¨ Ù…Ø´Ø±ÙˆØ¹Ùƒ: index.html Ø£Ùˆ /
      location.href = "index.html";
    };

    // Ø¹Ù†Ø¯Ù…Ø§ ÙŠÙƒÙˆÙ† Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…Ø³Ø¬Ù„ Ø¯Ø®ÙˆÙ„ØŒ Ù†Ø±Ø¬Ø¹Ù‡ Ù„Ù„ØµÙØ­Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©
    onAuthStateChanged(auth, (user) => {
      const d = $("dbg");
      if(d) d.textContent = tg ? "Ø¯Ø§Ø®Ù„ Telegram âœ…" : "Ø®Ø§Ø±Ø¬ Telegram (Ø§Ø®ØªØ¨Ø§Ø±) âœ…";
      if(user){
        // Ù†Ø¬Ø§Ø­: Ø±Ø¬Ù‘Ø¹ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
        showMsg("ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¨Ù†Ø¬Ø§Ø­. Ø³ÙŠØªÙ… Ø§Ù„Ø±Ø¬ÙˆØ¹ Ø§Ù„Ø¢Ù†â€¦", true);
        setTimeout(() => (location.href = "index.html"), 900);
      }
    });

    /************ EMAIL ************/
    window.emailLogin = async () => {
      hideMsg();
      const email = $("email").value.trim();
      const password = $("password").value;
      if(!email || !password) return showMsg("Ø§ÙƒØªØ¨ Ø§Ù„Ø¨Ø±ÙŠØ¯ ÙˆÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±.", false);

      try{
        await signInWithEmailAndPassword(auth, email, password);
        // onAuthStateChanged Ø³ÙŠØªÙˆÙ„Ù‰ Ø§Ù„Ø±Ø¬ÙˆØ¹
      }catch(e){
        showMsg("Ø®Ø·Ø£: " + (e?.message || e), false);
      }
    };

    window.emailSignup = async () => {
      hideMsg();
      const email = $("email").value.trim();
      const password = $("password").value;
      if(!email || !password) return showMsg("Ø§ÙƒØªØ¨ Ø§Ù„Ø¨Ø±ÙŠØ¯ ÙˆÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±.", false);
      if(password.length < 6) return showMsg("ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± ÙŠØ¬Ø¨ Ø£Ù† ØªÙƒÙˆÙ† 6 Ø£Ø­Ø±Ù Ø£Ùˆ Ø£ÙƒØ«Ø±.", false);

      try{
        await createUserWithEmailAndPassword(auth, email, password);
      }catch(e){
        showMsg("Ø®Ø·Ø£: " + (e?.message || e), false);
      }
    };

    window.emailReset = async () => {
      hideMsg();
      const email = $("email").value.trim();
      if(!email) return showMsg("Ø§ÙƒØªØ¨ Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø£ÙˆÙ„Ø§Ù‹.", false);

      try{
        await sendPasswordResetEmail(auth, email);
        showMsg("ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø±Ø§Ø¨Ø· Ø§Ø³ØªØ±Ø¬Ø§Ø¹ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø¥Ù„Ù‰ Ø¨Ø±ÙŠØ¯Ùƒ.", true);
      }catch(e){
        showMsg("Ø®Ø·Ø£: " + (e?.message || e), false);
      }
    };

    /************ PHONE ************/
    let confirmationResult = null;
    let recaptchaVerifier = null;

    function ensureRecaptcha(){
      if(recaptchaVerifier) return;
      // reCAPTCHA invisible Ù‚Ø¯Ø± Ø§Ù„Ø¥Ù…ÙƒØ§Ù†
      recaptchaVerifier = new RecaptchaVerifier(auth, "recaptcha-container", {
        size: "invisible"
      });
      recaptchaVerifier.render().catch(()=>{});
    }

    window.sendCode = async () => {
      hideMsg();
      const phone = $("phone").value.trim();
      if(!phone.startsWith("+")) return showMsg("Ø§ÙƒØªØ¨ Ø§Ù„Ø±Ù‚Ù… Ù…Ø¹ ÙƒÙˆØ¯ Ø§Ù„Ø¯ÙˆÙ„Ø© Ù…Ø«Ù„ +961â€¦", false);

      try{
        ensureRecaptcha();
        confirmationResult = await signInWithPhoneNumber(auth, phone, recaptchaVerifier);
        $("otpBox").classList.remove("hide");
        showMsg("ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„ÙƒÙˆØ¯. Ø£Ø¯Ø®Ù„Ù‡ Ø§Ù„Ø¢Ù†.", true);
      }catch(e){
        showMsg("Ø®Ø·Ø£ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„ÙƒÙˆØ¯: " + (e?.message || e), false);
      }
    };

    window.confirmCode = async () => {
      hideMsg();
      const code = $("otp").value.trim();
      if(!confirmationResult) return showMsg("Ø£Ø±Ø³Ù„ Ø§Ù„ÙƒÙˆØ¯ Ø£ÙˆÙ„Ø§Ù‹.", false);
      if(code.length < 4) return showMsg("Ø£Ø¯Ø®Ù„ Ø§Ù„ÙƒÙˆØ¯ Ø¨Ø´ÙƒÙ„ ØµØ­ÙŠØ­.", false);

      try{
        await confirmationResult.confirm(code);
        // onAuthStateChanged Ø³ÙŠØªÙˆÙ„Ù‰ Ø§Ù„Ø±Ø¬ÙˆØ¹
      }catch(e){
        showMsg("Ø§Ù„ÙƒÙˆØ¯ ØºÙŠØ± ØµØ­ÙŠØ­ Ø£Ùˆ Ù…Ù†ØªÙ‡ÙŠ: " + (e?.message || e), false);
      }
    };

    window.clearPhoneFlow = () => {
      $("phone").value = "";
      $("otp").value = "";
      $("otpBox").classList.add("hide");
      confirmationResult = null;
      hideMsg();
    };
  </script>
</body>
</html>
